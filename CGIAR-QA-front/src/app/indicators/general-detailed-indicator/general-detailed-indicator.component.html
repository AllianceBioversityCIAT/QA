<a class="nav-item nav-link" [routerLinkActive]="['active']"
    routerLink="/indicator/{{ params.type}}/{{ params.primary_column}}">
    <i class=icon-go-back></i> {{currentType}} List
</a>
<!-- <div class="data-header">
</div> -->

<div class="row criteria-container">
    <div *ngIf="!criteria_loading">
        <h2>QUALITY ASSESSMENT CRITERIA</h2>
        <ul>
            <li *ngFor="let criteria of criteriaData" [innerHTML]="criteria.description | markdown"></li>
        </ul>
    </div>
    <div style="margin:auto;">
        <span *ngIf="criteria_loading" class="spinner-border spinner-border-sm mr-1"></span>
    </div>
</div>

<div *ngIf="detailedData && detailedData[0] " class="row detail-header-container">
    <p class="indicator-item-name">
        {{detailedData[0].crp_acronym}} / {{currentType}} /
        QA-{{ params.type.charAt(0) }}{{ params.type.charAt(1).toUpperCase() }}-{{params.indicatorId}}
    </p>
    <div *ngIf="detailedData[0]">
        <a *ngIf="detailedData[0].public_link" [href]="detailedData[0].public_link" target="_blank">
            <div tooltip="{{tooltips.public_link}}" container="body" placement="top"
                class="btn btn-primary file-button">
                <i class="icon-public-link"></i>
            </div>
        </a>

        <div tooltip="{{tooltips.download_excel}}" container="body" placement="top" *ngIf="detailedData"
            (click)="getCommentsExcel(detailedData[0])" class="btn btn-primary file-button">
            <i class="icon-download-excel"></i>
        </div>
    </div>
    <p>Status: <span
            class="text-{{(gnralInfo.status === statusHandler.Complete) ? 'success':'danger'}}">{{(gnralInfo.status === statusHandler.Complete) ? "Completed":"Pending"}}</span>
    </p>
</div>


<form [formGroup]="tickGroup">
    <div class="row detail-container">
        <div class="col-sm">
            <div class="col data-container">
                <div class="select-all" *ngIf="detailedData">
                    <input (change)="onChangeSelectAll($event)" id="selectAll" type="checkbox"
                        class="custom-control-input" value="selectAll" name="selectAll" formControlName="selectAll">
                    <label tooltip="{{tooltips.all_approved}}" container="body" placement="top"
                        class="custom-control-label" for="selectAll">
                        Approved all items to be assessed.
                    </label>
                </div>
                <ng-container formArrayName="tick" *ngFor="let summon of formTickData.controls; let i = index">

                    <ng-container *ngIf="detailedData" [formGroupName]="i">
                        <div class="data-row">
                            <div class="col">
                                <div class="row">
                                    <input *ngIf="detailedData[i].replies_count == '0' || summon.value.isChecked "
                                        (change)="onTickChange($event,detailedData[i])"
                                        [value]="detailedData[i].field_id" formControlName="isChecked" type="checkbox"
                                        class="custom-control-input" id="field-{{detailedData[i].field_id}}">

                                    <label *ngIf="detailedData[i].replies_count == '0' || summon.value.isChecked "
                                        class="custom-control-label" for="field-{{detailedData[i].field_id}}">
                                        <h2>{{detailedData[i].display_name}}</h2>
                                    </label>
                                    <h2 *ngIf="detailedData[i].replies_count != '0' && !summon.value.isChecked ">
                                        {{detailedData[i].display_name}}</h2>

                                    <div *ngIf="detailedData[i].meta_description">
                                        <i tooltip="{{detailedData[i].meta_description}}" container="body"
                                            placement="top" class="icon-pdf" style="height: 2em;"></i>

                                    </div>
                                </div>

                                <div *ngIf="detailedData[i].value && (detailedData[i].col_name !== 'evidence_link' && detailedData[i].col_name !== 'outcome_description' )"
                                    [innerHTML]="detailedData[i].value | markdown">
                                </div>
                                <div *ngIf="detailedData[i].value && (detailedData[i].col_name === 'outcome_description' )"
                                    [innerHTML]="detailedData[i].value">
                                </div>
                                <a *ngIf="detailedData[i].value &&  detailedData[i].col_name === 'evidence_link'"
                                    href="{{detailedData[i].value}}" target="_blank"> {{detailedData[i].value}} </a>
                                <p *ngIf="!detailedData[i].value" class="empty-value">Data not provided.</p>

                            </div>

                            <div #commentsElem
                                *ngIf="validateCommentAvility(detailedData[i],true) && !summon.value.isChecked"
                                (click)="showComments(i, detailedData[i]); comment.updateData(detailedData[i],params)"
                                class="activate-messages-container {{detailedData[i].replies_count == '0' ?  '':'active'}}">

                                <i *ngIf="!detailedData[i].loading" class="icon-message"></i>
                                <span *ngIf="detailedData[i].loading"
                                    class="spinner-border spinner-border-sm mr-1"></span>

                                <div *ngIf="detailedData[i].replies_count != '0'" class="replies-count">
                                    {{detailedData[i].replies_count}}
                                </div>
                            </div>

                            <div *ngIf="!validateCommentAvility(detailedData[i]) || summon.value.isChecked"
                                class="activate-messages-container">
                                <i *ngIf="!detailedData[i].loading" class="icon-message-inactive"></i>
                                <span *ngIf="detailedData[i].loading"
                                    class="spinner-border spinner-border-sm mr-1"></span>

                                <div *ngIf="detailedData[i].replies_count != '0'" class="replies-count">
                                    {{detailedData[i].replies_count}}
                                </div>
                            </div>
                        </div>

                    </ng-container>
                </ng-container>

            </div>
            <div *ngIf="detailedData" class="col data-container">
                <div class="data-row  gnral-commnts">
                    <h2>General comments:</h2>
                    <p class="informative-text">
                        Please take into consideration that this comments are going to be shown to the CRP.
                    </p>
                    <form [formGroup]="generalCommentGroup">
                        <textarea cols="30" rows="5" formControlName="general_comment"></textarea>
                    </form>
                    <div class="bton-container">
                        <p class="error" *ngIf="this.tickGroup.controls['tick'].errors?.required">
                            Checkbox is required, select atleast one value.
                        </p>
                        <button type="button" class="btn btn-green-secondary"
                            [disabled]="!generalCommentGroup.valid || gnralInfo.status === statusHandler.Complete"
                            (click)="updateEvaluation('general_comment', detailedData)">SAVE</button>
                        <!-- [disabled]="validateComments()" -->
                        <!-- <button type="button" (click)="updateEvaluation('status', detailedData)"
                            class="btn btn-{{(gnralInfo.status === statusHandler.Complete) ? 'danger':'primary'}}">{{(gnralInfo.status === statusHandler.Complete) ? "REOPEN":"COMPLETE"}}</button> -->
                    </div>

                </div>
            </div>
            <ngx-spinner [fullScreen]="false" [name]="spinner1" bdColor="rgba(51,51,51,0.3)" type="ball-clip-rotate"
                size="medium">
            </ngx-spinner>
        </div>

        <div [ngClass]="{'hide' : !activeCommentArr[fieldIndex] }" [style.padding-top.px]="currentY"
            class="col-sm-4 comments-container">
            <app-comment #comment (parentFun)="showComments(fieldIndex, detailedData[fieldIndex])"
                (updateNumCommnts)="updateNumCommnts($event,detailedData[fieldIndex])"></app-comment>
        </div>


    </div>


</form>